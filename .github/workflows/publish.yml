name: ğŸš€ Publish NuGet Package

permissions:
  contents: write # Needed to create GitHub releases

on:
  push:
    tags:
      - 'v*'

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  NUGET_SOURCE: https://api.nuget.org/v3/index.json

jobs:
  build-pack-release-publish:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: ğŸ§¾ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: ğŸ› ï¸ Build
        run: dotnet build --configuration Release

      - name: ğŸ“¦ Pack with Tag Version
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          mkdir -Force artifacts
          dotnet pack --configuration Release `
            --output artifacts `
            /p:Version=$version

      - name: ğŸ“ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Push to NuGet
        run: |
          foreach ($file in Get-ChildItem "artifacts" -Filter *.nupkg) {
            dotnet nuget push $file.FullName `
              --api-key "${{ secrets.NUGET_API_KEY }}" `
              --source "${{ env.NUGET_SOURCE }}" `
              --skip-duplicate
          }
